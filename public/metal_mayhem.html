<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
    <style>
        #gameContainer {
            width: 845px;
            height: 480px;
            border: 1px solid black;
            position: relative;
            overflow: hidden;
        }

        #staticBackground,
        #gameCanvas {
            position: absolute;
            top: 0;
            left: 0;
        }

        #staticBackground {
            z-index: 1;
        }

        #gameCanvas {
            z-index: 2;
        }

        body {
            margin: 0;
        }
    </style>

</head>

<body>
    <!-- Your sprites will be appended here -->
    <div id="gameContainer">
        <div id="staticBackground"></div>
        <canvas id="gameCanvas" width="845px" height="480px"></canvas>
    </div>

    <!-- Your JavaScript code will go here -->
    <script src="renderer/background/background_sprite.js"></script>
    <script src="renderer/background/generate_pipes.js"></script>
    <script src="renderer/background/generate_vents.js"></script>
    <script src="renderer/weapon.js"></script>
    <script src="renderer/sprite.js"></script>
    <script src="renderer/item.js"></script>
    <script src="renderer/platform.js"></script>
    <script src="renderer/bounding_box.js"></script>
    <script src="renderer/item_ctrl.js"></script>
    <script src="renderer/background/generate_background.js"></script>
    <script src="renderer/player.js"></script>
    <!-- Listener -->
    <script src="listener/platform_listener.js"></script>
    <script src="listener/player_listener.js"></script>


    <!-- Server -->
    <!-- <script src="server/authentication.js"></script>
    <script src="server/avatar.js"></script> -->
    <!-- <script src="server/registration.js"></script> -->
    <script src="/socket.io/socket.io.js"></script>
    <script src="socket.js"></script>

    <!-- <script src="server/server_side_game_mechanics/GameManager.js"></script>
    <script src="server/server_side_game_mechanics/Map.js"></script>
    <script src="server/server_side_game_mechanics/PlayerState.js"></script>  -->







    <script>
        $(document).ready(function () {

            // Validate the signin
            // Authentication.validate(
            //     () => {
            //         SignInForm.hide();
            //         UserPanel.update(Authentication.getUser());
            //         UserPanel.show();

            //         Socket.connect();
            //     },
            //     () => { SignInForm.show(); }
            // );
            const cv = $("canvas").get(0);
            const context = cv.getContext("2d");
            let username = "username";
            BackgroundGenerator.generateBackground("#staticBackground");
            Socket.connect();
            socket = Socket.getSocket();
            PlatformListener.init({ ctx: context, socket: socket });
            // PlayerListener.init({ ctx: context, socket: socket });
            let wep0 = Weapon({ ctx: context, wep_id: 0, x: 0, y: 0, scale: 1.7, rotation: 0 });
            const player = Player(context, 400, 300); // The player
            // wep0.setRotation(-);
            player.setWeapon(0);
            socket.emit('ready');

            // let wep1 = Weapon({ ctx: context, wep_id: 1, x: 100, y: 50 });
            // let wep2 = Weapon({ ctx: context, wep_id: 2, x: 150, y: 50 });
            // let wep3 = Weapon({ ctx: context, wep_id: 3, x: 200, y: 50 });
            // let wep4 = Weapon({ ctx: context, wep_id: 4, x: 250, y: 50 });
            // let wep5 = Weapon({ ctx: context, wep_id: 5, x: 300, y: 50 });
            // let wep6 = Weapon({ ctx: context, wep_id: 6, x: 350, y: 50 });
            // let wep7 = Weapon({ ctx: context, wep_id: 7, x: 400, y: 50 });
            // let weapons = [wep0, wep1, wep2, wep3, wep4, wep5, wep6, wep7];



            // let items = [];
            // items.push(Item({ ctx: context, wep_id: 0, x: 422.25, y: 200, lifetime: 5000 }));
            // items.push(Item({ ctx: context, wep_id: 1, x: 500.25, y: 200, lifetime: 5000 }));


            // let NUM_PLATFORM = 7;
            // let PLATFORM_SPACING = 100;
            // let platform_1 = Platform({ ctx: context, type: "thick", x: 17, y: 400, num_platforms: NUM_PLATFORM });
            // let platform_2 = Platform({ ctx: context, type: "thick", x: 635, y: 400, num_platforms: NUM_PLATFORM });
            // let platform_3 = Platform({ ctx: context, type: "thick", x: 335, y: 400 - PLATFORM_SPACING, num_platforms: NUM_PLATFORM });
            // let platform_4 = Platform({ ctx: context, type: "thick", x: 17, y: 400 - PLATFORM_SPACING * 2, num_platforms: NUM_PLATFORM });
            // let platform_5 = Platform({ ctx: context, type: "thick", x: 635, y: 400 - PLATFORM_SPACING * 2, num_platforms: NUM_PLATFORM });
            // let platform_6 = Platform({ ctx: context, type: "thick", x: 335, y: 400 - PLATFORM_SPACING * 3, num_platforms: NUM_PLATFORM });

            // let platforms = [platform_1, platform_2, platform_3, platform_4, platform_5, platform_6];
            // var socket = io.connect('http://localhost:8000');

            /* inside game loop
                 for (let platform of platforms) {
                     platform.draw();
                 }
                 */
            // let itemController = ItemCtrl({context: context, platforms: platforms});
            let startTime;
            let elapsedTime;
            let gameLoopStarted = false;

            function gameLoop(timestamp) {

                if (!startTime) {
                    startTime = timestamp;
                }

                elapsedTime = timestamp - startTime;
                context.clearRect(0, 0, cv.width, cv.height);
                PlatformListener.draw();
                PlayerListener.draw();
                player.update(timestamp);
                player.draw();

                // items = items.filter(item => !item.update());
                // Render the game...
                // Clear the canvas for the new frame
                // for (let item of items) {
                //     item.draw();
                // }
                // console.log
                // Spawn item
                // itemController.spawnItem(elapsedTime);

                // Update the state of all items
                // itemController.updateItems();

                // Draw all items
                // itemController.drawItems();

                // for (let item of items){
                //     item.draw();
                // }
                //     for (let weapon of weapons) {
                //         weapon.draw();
                //     }
                //     for (let platform of platforms) {
                //         platform.draw();
                //     }

                //     // Call the next game loop
                // context.clearRect(0, 0, cv.width, cv.height);

                if (gameLoopStarted) {
                    requestAnimationFrame(gameLoop);
                }
            }


            // Start the game loop
            requestAnimationFrame(gameLoop);

            function startGameLoop() {
                gameLoopStarted = true;
                requestAnimationFrame(gameLoop);
            }

            function stopGameLoop() {
                gameLoopStarted = false;
            }

            socket.on("start", () => {
                startGameLoop();
            });

            socket.on("stop", () => {
                stopGameLoop();
            });


            const DIR_LEFT = 1;
            const DIR_RIGHT = 2;
            const DIR_JUMP = 3;


            $(document).on('keydown', function (event) {
                let dir;
                if (event.key === 'w' || event.key === 'W') {
                    dir = "jump";
                } else if (event.key === 'a' || event.key === 'A') {
                    dir = "left";
                } else if (event.key === 'd' || event.key === 'D') {
                    dir = "right";
                }
                else {
                    return;
                }

                Socket.onKeyDown(JSON.stringify({ user: username, key: event.key }));
                player.move_animation(dir);
            });

            $(document).on("keyup", function (event) {
                let dir;
                if (event.key === 'w' || event.key === 'W') {
                    dir = "jump";
                } else if (event.key === 'a' || event.key === 'A') {
                    dir = "left";
                } else if (event.key === 'd' || event.key === 'D') {
                    dir = "right";
                }
                else {
                    return;
                }
                Socket.onKeyUp(JSON.stringify({ user: username, key: event.key }));

                player.stop_animation(dir);
            });

            $(document).on('mousemove', function (evt) {
                const rect = cv.getBoundingClientRect();
                const mouseX = evt.pageX - rect.left;
                const mouseY = evt.pageY - rect.top;

                // Assuming `player` is your Player object
                const { x: playerX, y: playerY } = player.getXY();

                // Calculate the angle between the player and the mouse
                const angle = Math.atan2(mouseY - playerY, mouseX - playerX) * (180.0 / Math.PI);

                // Set the rotation of the weapon
                player.setWeaponRotation(angle);
            });



        });

    </script>
</body>

</html>